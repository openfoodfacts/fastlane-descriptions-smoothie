name: Fastlane Metadata
on:
  push:
    branches:
      - 'upload-to-playstore'
jobs:
  marketing:
    runs-on: ubuntu-latest
    steps:
    # required to run on Linux because this is a docker container action
     - name: Checkout
       uses: actions/checkout@v1
     - name: Validate metadata
       uses: ashutoshgngwr/validate-fastlane-supply-metadata@v1
       with:
        fastlaneDir: ./fastlane # optional. default is './fastlane'.
        # enable check to validate if a locale is supported by the Play Store Listing.
        usePlayStoreLocales: true # optional. default is false.
     - name: Decrypt API JSON file
       run : |
          cd ./fastlane/envfiles
          echo "$B64_JSON" > play_config.json.b64
          base64 -d -i play_config.json.b64 > api-4712693179220384697-162836-33ea08672303.json
       env:
        B64_JSON: ${{ env.B64_JSON }}
     - name: Play Store Upload
       if: github.repository == 'openfoodfacts/fastlane-descriptions-smoothie'
       timeout-minutes: 10
       uses: ruby/setup-ruby@v1
       with:
        ruby-version: 2.7
        run: echo "$API_JSON_FILE_DECRYPTKEY" > service-account-key.json && bundle install && bundle exec fastlane upload_metadata
     - name: Cleanup
       if: ${{ always() }}
       run: rm -f service-account-key.json
