name: Fastlane Metadata
on:
  push:
    branches:
      - 'upload-to-playstore'
jobs:
  marketing:
    runs-on: ubuntu-latest
    steps:
    # required to run on Linux because this is a docker container action
     - name: Checkout
       uses: actions/checkout@v1
     - name: Validate metadata
       uses: ashutoshgngwr/validate-fastlane-supply-metadata@v1
       with:
        fastlaneDir: ./fastlane # optional. default is './fastlane'.
        # enable check to validate if a locale is supported by the Play Store Listing.
        usePlayStoreLocales: true # optional. default is false.
     - name: Decrypt API JSON file
       run: cd ./fastlane/envfiles && chmod +x ./decrypt_secrets.sh && ./decrypt_secrets.sh
       env:
        API_JSON_FILE_DECRYPTKEY: ${{ API_JSON_FILE_DECRYPTKEY }}
     - name: Play Store Upload
       if: github.repository == 'openfoodfacts/fastlane-descriptions-smoothie'
       timeout-minutes: 10
       uses: ruby/setup-ruby@v1
       with:
        ruby-version: 2.7
        run: echo "$API_JSON_FILE_DECRYPTKEY" > service-account-key.json && bundle install && bundle exec fastlane upload_metadata
     - name: Cleanup
       if: ${{ always() }}
       run: rm -f service-account-key.json
